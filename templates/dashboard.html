{% extends "base.html" %}

{% block title %}Dashboard - LearnStyle AI{% endblock %}

{% block head %}
<style>
/* Modern Dashboard Styles */
.dashboard-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 1rem;
    background: #f8f9fa;
    min-height: 100vh;
}

/* Compact Header */
.welcome-section {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 20px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
    position: relative;
    overflow: hidden;
}

.welcome-section::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.1"/><circle cx="75" cy="75" r="1" fill="white" opacity="0.1"/><circle cx="50" cy="10" r="0.5" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
    opacity: 0.3;
}

.welcome-content {
    position: relative;
    z-index: 1;
}

.welcome-title {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    gap: 1rem;
}

.welcome-subtitle {
    font-size: 1rem;
    opacity: 0.9;
    margin-bottom: 0;
}

/* Modern Grid Layout */
.dashboard-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
    margin-bottom: 1.5rem;
}

.dashboard-grid.full-width {
    grid-template-columns: 1fr;
}

.dashboard-grid.three-col {
    grid-template-columns: 1fr 1fr 1fr;
}

/* Modern Cards */
.modern-card {
    background: white;
    border-radius: 20px;
    padding: 1.5rem;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    border: 1px solid rgba(0, 0, 0, 0.05);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.modern-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
}

.modern-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #667eea, #764ba2);
}

/* Learning Style Card */
.learning-style-card {
    background: white;
    border-radius: 20px;
    padding: 1.5rem;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    border: 1px solid rgba(0, 0, 0, 0.05);
    position: relative;
    overflow: hidden;
}

.learning-style-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #28a745, #20c997);
}

/* Compact Style Breakdown */
.style-breakdown {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 1rem;
    margin: 1rem 0;
}

.style-item {
    text-align: center;
    padding: 0.5rem;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    transition: all 0.3s ease;
}

.style-item:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: translateY(-2px);
}

.style-circle {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 0.5rem;
    font-size: 1.5rem;
    color: white;
    font-weight: bold;
    position: relative;
    overflow: hidden;
}

.style-circle.visual {
    background: linear-gradient(135deg, #3498db, #2980b9);
}

.style-circle.auditory {
    background: linear-gradient(135deg, #e74c3c, #c0392b);
}

.style-circle.kinesthetic {
    background: linear-gradient(135deg, #f39c12, #e67e22);
}

.style-percentage {
    font-size: 1.5rem;
    font-weight: bold;
}

.style-label {
    font-size: 0.9rem;
    font-weight: 500;
    color: white;
    margin-top: 0.25rem;
}

/* Compact Stats */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
    margin: 1rem 0;
}

.stat-item {
    text-align: center;
    padding: 1rem;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    transition: all 0.3s ease;
}

.stat-item:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: translateY(-2px);
}

.stat-number {
    font-size: 1.5rem;
    font-weight: bold;
    color: white;
    margin-bottom: 0.25rem;
}

.stat-label {
    font-size: 0.8rem;
    color: rgba(255, 255, 255, 0.8);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Collapsible Sections */
.collapsible-section {
    margin-bottom: 1rem;
}

.collapsible-header {
    background: white;
    border-radius: 15px;
    padding: 1rem 1.5rem;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    transition: all 0.3s ease;
    border: 1px solid rgba(0, 0, 0, 0.05);
}

.collapsible-header:hover {
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    transform: translateY(-2px);
}

.collapsible-header h3 {
    margin: 0;
    font-size: 1.1rem;
    font-weight: 600;
    color: #333;
}

.collapsible-content {
    background: white;
    border-radius: 0 0 15px 15px;
    padding: 1.5rem;
    margin-top: -1px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
    border: 1px solid rgba(0, 0, 0, 0.05);
    border-top: none;
}

.collapsible-icon {
    transition: transform 0.3s ease;
}

.collapsible-header.collapsed .collapsible-icon {
    transform: rotate(-90deg);
}

/* Quick Actions */
.quick-actions {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin: 1rem 0;
}

.quick-action-btn {
    background: white;
    border: 2px solid #e9ecef;
    border-radius: 15px;
    padding: 1rem;
    text-align: center;
    text-decoration: none;
    color: #333;
    transition: all 0.3s ease;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
}

.quick-action-btn:hover {
    border-color: #667eea;
    color: #667eea;
    transform: translateY(-3px);
    box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
}

.quick-action-icon {
    font-size: 1.5rem;
    margin-bottom: 0.5rem;
}

/* Responsive Design */
@media (max-width: 768px) {
    .dashboard-grid {
        grid-template-columns: 1fr;
    }
    
    .dashboard-grid.three-col {
        grid-template-columns: 1fr;
    }
    
    .welcome-title {
        font-size: 1.5rem;
        flex-direction: column;
        text-align: center;
    }
    
    .style-breakdown {
        grid-template-columns: 1fr;
    }
    
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

.dominant-style {
    text-align: center;
    margin-top: 2rem;
    padding: 1.5rem;
    background: #f8f9fa;
    border-radius: 10px;
}

.dominant-style h3 {
    color: #28a745;
    margin-bottom: 1rem;
}

.content-recommendations {
    background: white;
    border-radius: 15px;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.content-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
    margin-top: 1.5rem;
}

.content-card {
    border: 1px solid #e9ecef;
    border-radius: 10px;
    padding: 1.5rem;
    transition: all 0.3s ease;
    cursor: pointer;
}

.content-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    border-color: #007bff;
}

.content-type {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 15px;
    font-size: 0.8rem;
    font-weight: 500;
    margin-bottom: 1rem;
}

.content-type.video {
    background: #e3f2fd;
    color: #1976d2;
}

.content-type.audio {
    background: #f3e5f5;
    color: #7b1fa2;
}

.content-type.interactive {
    background: #e8f5e8;
    color: #388e3c;
}

.content-type.text {
    background: #fff3e0;
    color: #f57c00;
}

.content-title {
    font-size: 1.2rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: #333;
}

.content-description {
    color: #666;
    margin-bottom: 1rem;
    line-height: 1.5;
}

.content-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.9rem;
    color: #888;
}

.progress-section {
    background: white;
    border-radius: 15px;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.progress-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
    margin-top: 1.5rem;
}

.stat-card {
    text-align: center;
    padding: 1.5rem;
    background: #f8f9fa;
    border-radius: 10px;
}

.stat-number {
    font-size: 2rem;
    font-weight: bold;
    color: #007bff;
    margin-bottom: 0.5rem;
}

.stat-label {
    color: #666;
    font-weight: 500;
}

.quick-actions {
    display: flex;
    gap: 1rem;
    margin-top: 2rem;
    flex-wrap: wrap;
}

.btn-action {
    flex: 1;
    min-width: 200px;
    padding: 1rem 2rem;
    border-radius: 25px;
    font-weight: 500;
    text-decoration: none;
    text-align: center;
    transition: all 0.3s ease;
}

.btn-action:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    text-decoration: none;
}

/* Question & Answer Styles */
.question-answer-section {
    background: #f8f9fa;
    border-radius: 15px;
    padding: 2rem;
    margin-bottom: 2rem;
}

.question-input-container {
    margin-bottom: 2rem;
}

.quick-questions {
    margin-top: 1rem;
}

.question-answer-result {
    animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.answer-card {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    border-left: 4px solid #007bff;
}

.answer-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.answer-content {
    line-height: 1.6;
    margin-bottom: 1.5rem;
}

.answer-actions {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.rating-stars {
    display: inline-block;
}

.rating-star {
    color: #ddd;
    cursor: pointer;
    font-size: 1.2rem;
    margin-right: 2px;
    transition: color 0.2s;
}

.rating-star:hover,
.rating-star.filled {
    color: #ffc107;
}

.rating-star:hover {
    transform: scale(1.1);
}

/* Enhanced Content Cards */
.content-card {
    position: relative;
    overflow: hidden;
}

.content-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transition: left 0.5s;
}

.content-card:hover::before {
    left: 100%;
}

.content-card .content-type {
    position: relative;
    z-index: 2;
}

/* Recommendation Filters */
.recommendation-filters {
    display: flex;
    justify-content: center;
    margin-bottom: 2rem;
}

/* Loading States */
.loading-spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid #f3f3f3;
    border-top: 3px solid #007bff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Progress Enhancement */
.progress-ring {
    transform: rotate(-90deg);
}

.progress-ring-circle {
    stroke-dasharray: 283;
    stroke-dashoffset: 283;
    transition: stroke-dashoffset 0.5s ease-in-out;
}

/* Interactive Elements */
.interactive-element {
    cursor: pointer;
    transition: all 0.3s ease;
}

.interactive-element:hover {
    transform: scale(1.02);
}

/* Responsive Improvements */
@media (max-width: 768px) {
    .answer-actions {
        flex-direction: column;
    }
    
    .answer-actions .btn {
        width: 100%;
    }
    
    .quick-questions {
        text-align: center;
    }
    
    .quick-questions .btn {
        margin: 0.25rem;
    }
}

@media (max-width: 768px) {
    .dashboard-container {
        padding: 1rem;
    }
    
    .style-breakdown {
        flex-direction: column;
        gap: 1.5rem;
    }
    
    .style-item {
        margin: 0;
    }
    
    .content-grid {
        grid-template-columns: 1fr;
    }
    
    .quick-actions {
        flex-direction: column;
    }
    
    .btn-action {
        min-width: auto;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Welcome Section -->
    <div class="welcome-section">
        <div class="welcome-content">
            <h1 class="welcome-title">
                <i class="bi bi-person-circle"></i> Welcome back, {{ current_user.username }}!
                {% if current_user.is_admin() %}
                <span class="badge bg-danger ms-2">Admin</span>
                {% elif current_user.is_moderator() %}
                <span class="badge bg-warning ms-2">Moderator</span>
                {% endif %}
            </h1>
            <p class="welcome-subtitle">
                Your personalized learning journey continues. Here's what we've prepared for you today.
            </p>
            
            <!-- Quick Stats -->
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-number">{{ progress_stats.content_completed }}</div>
                    <div class="stat-label">Content Completed</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">{{ progress_stats.hours_learned }}</div>
                    <div class="stat-label">Hours Learned</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">{{ progress_stats.achievement_badges }}</div>
                    <div class="stat-label">Achievements</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">{{ progress_stats.average_score }}</div>
                    <div class="stat-label">Avg Score</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Dashboard Grid -->
    <div class="dashboard-grid">
        <!-- Learning Style Profile -->
        <div class="modern-card">
            <h3 class="mb-3">
                <i class="bi bi-graph-up"></i> Learning Style Profile
            </h3>
        
        {% if user_profile and user_profile.visual_score > 0 %}
        <div class="style-breakdown">
            <div class="style-item">
                <div class="style-circle visual">
                    <i class="bi bi-eye"></i>
                </div>
                <div class="style-percentage">{{ user_profile.get_style_breakdown().visual }}%</div>
                <div class="style-label">Visual Learner</div>
            </div>
            
            <div class="style-item">
                <div class="style-circle auditory">
                    <i class="bi bi-volume-up"></i>
                </div>
                <div class="style-percentage">{{ user_profile.get_style_breakdown().auditory }}%</div>
                <div class="style-label">Auditory Learner</div>
            </div>
            
            <div class="style-item">
                <div class="style-circle kinesthetic">
                    <i class="bi bi-hand-index"></i>
                </div>
                <div class="style-percentage">{{ user_profile.get_style_breakdown().kinesthetic }}%</div>
                <div class="style-label">Kinesthetic Learner</div>
            </div>
        </div>
        
            <div class="dominant-style">
                <h4 class="mb-2">
                    <i class="bi bi-star-fill text-warning"></i> 
                    {{ user_profile.dominant_style.title() }} Learner
                </h4>
                <p class="mb-0" style="color: #333; font-weight: 500; font-size: 0.9rem;">
                    {% if user_profile.dominant_style == 'visual' %}
                    You learn best through visual aids, diagrams, and written materials.
                    {% elif user_profile.dominant_style == 'auditory' %}
                    You learn best through listening and verbal communication.
                    {% else %}
                    You thrive with experiential learning and tactile engagement.
                    {% endif %}
                </p>
            </div>
        </div>
        {% else %}
        <div class="text-center py-4">
            <i class="bi bi-clipboard-check text-muted" style="font-size: 3rem;"></i>
            <h4 class="mt-3 text-muted">Complete Your Learning Style Assessment</h4>
            <p class="text-muted">Take our 15-question quiz to discover your unique learning preferences and get personalized recommendations.</p>
            <a href="{{ url_for('quiz') }}" class="btn btn-primary btn-lg">
                <i class="bi bi-play-circle"></i> Start Assessment
            </a>
        </div>
        {% endif %}
        
        <!-- Quick Actions -->
        <div class="modern-card">
            <h3 class="mb-3">
                <i class="bi bi-lightning"></i> Quick Actions
            </h3>
            <div class="quick-actions">
                <a href="{{ url_for('quiz') }}" class="quick-action-btn">
                    <i class="bi bi-clipboard-check quick-action-icon"></i>
                    <span>Take Quiz</span>
                </a>
                <a href="{{ url_for('chat') }}" class="quick-action-btn">
                    <i class="bi bi-chat-dots quick-action-icon"></i>
                    <span>AI Tutor</span>
                </a>
                <a href="{{ url_for('explainable_ai') }}" class="quick-action-btn">
                    <i class="bi bi-robot quick-action-icon"></i>
                    <span>AI Insights</span>
                </a>
                <a href="{{ url_for('advanced_dashboard') }}" class="quick-action-btn">
                    <i class="bi bi-graph-up quick-action-icon"></i>
                    <span>Analytics</span>
                </a>
            </div>
        </div>
    </div>

    <!-- Collapsible Sections -->
    <div class="collapsible-section">
        <div class="collapsible-header" onclick="toggleCollapsible('qa-section')">
            <h3><i class="bi bi-question-circle"></i> Ask Questions & Get Answers</h3>
            <i class="bi bi-chevron-down collapsible-icon"></i>
        </div>
        <div class="collapsible-content" id="qa-section">
        
        <div class="question-answer-section">
            <div class="question-input-container">
                <div class="input-group mb-3">
                    <input type="text" class="form-control" id="questionInput" 
                           placeholder="Ask me anything about learning, topics, or concepts..." 
                           onkeypress="handleQuestionKeyPress(event)">
                    <button class="btn btn-primary" onclick="askQuestion()">
                        <i class="bi bi-search"></i> Ask
                    </button>
                </div>
                <div class="quick-questions">
                    <span class="text-muted me-2">Quick questions:</span>
                    <button class="btn btn-outline-primary btn-sm me-2" onclick="askQuickQuestion('What is machine learning?')">What is ML?</button>
                    <button class="btn btn-outline-primary btn-sm me-2" onclick="askQuickQuestion('How do neural networks work?')">Neural Networks</button>
                    <button class="btn btn-outline-primary btn-sm me-2" onclick="askQuickQuestion('Explain data visualization')">Data Viz</button>
                    <button class="btn btn-outline-primary btn-sm" onclick="askQuickQuestion('Python programming tips')">Python Tips</button>
                </div>
            </div>
            
            <div id="questionAnswer" class="question-answer-result" style="display: none;">
                <div class="answer-card">
                    <div class="answer-header">
                        <h5 id="answerTitle" class="mb-2"></h5>
                        <span class="badge bg-info" id="answerStyle"></span>
                    </div>
                    <div id="answerContent" class="answer-content"></div>
                    <div class="answer-actions">
                        <button class="btn btn-sm btn-outline-primary" onclick="generateContent()">
                            <i class="bi bi-plus-circle"></i> Generate Content
                        </button>
                        <button class="btn btn-sm btn-outline-success" onclick="saveToLibrary()">
                            <i class="bi bi-bookmark"></i> Save
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="askFollowUp()">
                            <i class="bi bi-arrow-right"></i> Ask Follow-up
                        </button>
                        <div class="rating-section mt-2">
                            <span class="text-muted me-2">Rate this answer:</span>
                            <div class="rating-stars">
                                <i class="bi bi-star rating-star" data-rating="1" onclick="rateAnswer(1)"></i>
                                <i class="bi bi-star rating-star" data-rating="2" onclick="rateAnswer(2)"></i>
                                <i class="bi bi-star rating-star" data-rating="3" onclick="rateAnswer(3)"></i>
                                <i class="bi bi-star rating-star" data-rating="4" onclick="rateAnswer(4)"></i>
                                <i class="bi bi-star rating-star" data-rating="5" onclick="rateAnswer(5)"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Dynamic Content Recommendations -->
    <div class="content-recommendations">
        <h2 class="mb-4">
            <i class="bi bi-bookmark-star"></i> Personalized Recommendations
            <button class="btn btn-sm btn-outline-primary float-end" onclick="refreshRecommendations()">
                <i class="bi bi-arrow-clockwise"></i> Refresh
            </button>
        </h2>
        
        <div class="recommendation-filters mb-3">
            <div class="btn-group" role="group">
                <input type="radio" class="btn-check" name="contentFilter" id="allContent" checked>
                <label class="btn btn-outline-primary" for="allContent">All</label>
                
                <input type="radio" class="btn-check" name="contentFilter" id="videoContent">
                <label class="btn btn-outline-primary" for="videoContent">Videos</label>
                
                <input type="radio" class="btn-check" name="contentFilter" id="interactiveContent">
                <label class="btn btn-outline-primary" for="interactiveContent">Interactive</label>
                
                <input type="radio" class="btn-check" name="contentFilter" id="textContent">
                <label class="btn btn-outline-primary" for="textContent">Articles</label>
            </div>
        </div>
        
        <div class="content-grid" id="recommendationsGrid">
            <!-- Dynamic content will be loaded here -->
        </div>
        
        <div class="text-center mt-4">
            <button class="btn btn-primary" onclick="generatePersonalizedContent()">
                <i class="bi bi-magic"></i> Generate New Content for Me
            </button>
        </div>
        </div>
    </div>

    <!-- Progress Tracking -->
    <div class="collapsible-section">
        <div class="collapsible-header" onclick="toggleCollapsible('progress-section')">
            <h3><i class="bi bi-graph-up-arrow"></i> Your Learning Progress</h3>
            <i class="bi bi-chevron-down collapsible-icon"></i>
        </div>
        <div class="collapsible-content" id="progress-section">
        
        {% if progress_stats.content_completed > 0 %}
        <div class="progress-stats">
            <div class="stat-card">
                <div class="stat-number">{{ progress_stats.content_completed }}</div>
                <div class="stat-label">Content Completed</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-number">{{ progress_stats.hours_learned }}</div>
                <div class="stat-label">Hours Learned</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-number">{{ progress_stats.achievement_badges }}</div>
                <div class="stat-label">Achievement Badges</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-number">{{ progress_stats.average_score }}</div>
                <div class="stat-label">Average Score</div>
            </div>
        </div>
        {% else %}
        <div class="no-progress-message">
            <div class="text-center py-5">
                <i class="bi bi-graph-up-arrow display-1 text-muted mb-3"></i>
                <h4 class="text-muted">No Progress Data Yet</h4>
                <p class="text-muted mb-4">Start learning to see your progress statistics here!</p>
                <a href="{{ url_for('quiz') }}" class="btn btn-primary">
                    <i class="bi bi-play-circle me-2"></i>Start Learning
                </a>
            </div>
        </div>
        {% endif %}
        </div>
    </div>

    <!-- Learning Sites Tracking Section -->
    <div class="collapsible-section">
        <div class="collapsible-header" onclick="toggleCollapsible('sites-section')">
            <h3><i class="bi bi-globe"></i> Learning Sites Activity</h3>
            <i class="bi bi-chevron-down collapsible-icon"></i>
        </div>
        <div class="collapsible-content" id="sites-section">
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">Recent Learning Sites</h6>
                    </div>
                    <div class="card-body">
                        <div id="recent-sites" class="recent-sites-list">
                            <div class="text-muted">Loading recent activity...</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">Tracking Status</h6>
                    </div>
                    <div class="card-body">
                        <div class="tracking-status">
                            <div class="status-item d-flex justify-content-between align-items-center mb-2">
                                <span>Educational Sites</span>
                                <span id="edu-tracking-status" class="badge bg-secondary">Disabled</span>
                            </div>
                            <div class="status-item d-flex justify-content-between align-items-center mb-2">
                                <span>Coding Platforms</span>
                                <span id="coding-tracking-status" class="badge bg-secondary">Disabled</span>
                            </div>
                            <div class="status-item d-flex justify-content-between align-items-center mb-2">
                                <span>Video Learning</span>
                                <span id="video-tracking-status" class="badge bg-secondary">Disabled</span>
                            </div>
                            <div class="status-item d-flex justify-content-between align-items-center mb-2">
                                <span>Research Sites</span>
                                <span id="research-tracking-status" class="badge bg-secondary">Disabled</span>
                            </div>
                        </div>
                        <div class="mt-3">
                            <a href="{{ url_for('permissions') }}" class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-gear"></i> Manage Permissions
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="quick-actions">
        <a href="{{ url_for('quiz') }}" class="btn btn-primary btn-action">
            <i class="bi bi-clipboard-check"></i> Retake Assessment
        </a>
        
        <a href="{{ url_for('chat') }}" class="btn btn-success btn-action">
            <i class="bi bi-chat-dots"></i> AI Tutor Chat
        </a>
        
        <a href="{{ url_for('permissions') }}" class="btn btn-info btn-action">
            <i class="bi bi-shield-check"></i> Privacy & Permissions
        </a>
        
        <a href="#" class="btn btn-warning btn-action">
            <i class="bi bi-trophy"></i> View Achievements
        </a>
        
        {% if current_user.is_admin() %}
        <a href="{{ url_for('admin_dashboard') }}" class="btn btn-danger btn-action">
            <i class="bi bi-shield-check"></i> Admin Panel
        </a>
        {% endif %}
        
        {% if current_user.is_moderator() %}
        <a href="{{ url_for('moderator_dashboard') }}" class="btn btn-warning btn-action">
            <i class="bi bi-user-shield"></i> Moderator Panel
        </a>
        {% endif %}
    </div>
</div>

<script>
// Enhanced Dashboard Functionality
let currentRecommendations = [];
let userLearningStyle = '{{ user_profile.dominant_style if user_profile else "visual" }}';

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    initializeDashboard();
    loadRecommendations();
    setupEventListeners();
    loadLearningSitesData();
    loadPermissionsStatus();
    
    // Update learning profile periodically
    setInterval(updateLearningProfile, 300000); // Every 5 minutes
    
    // Start engagement tracking
    startEngagementTracking();
});

// Initialize dashboard components
function initializeDashboard() {
    // Animate progress bars on scroll
    const observerOptions = {
        threshold: 0.5,
        rootMargin: '0px 0px -50px 0px'
    };
    
    const observer = new IntersectionObserver(function(entries) {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.style.animation = 'fadeInUp 0.6s ease forwards';
            }
        });
    }, observerOptions);
    
    // Observe all cards
    document.querySelectorAll('.content-card, .stat-card').forEach(card => {
        observer.observe(card);
    });
}

// Setup event listeners
function setupEventListeners() {
    // Content filter listeners
    document.querySelectorAll('input[name="contentFilter"]').forEach(radio => {
        radio.addEventListener('change', filterContent);
    });
}

// Question & Answer System
function handleQuestionKeyPress(event) {
    if (event.key === 'Enter') {
        askQuestion();
    }
}

async function askQuestion() {
    const questionInput = document.getElementById('questionInput');
    const question = questionInput.value.trim();
    
    if (!question) return;
    
    showLoadingState();
    
    try {
        // Call real API endpoint
        const response = await fetch('/api/ask-question', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ question: question })
        });
        
        const data = await response.json();
        
        if (data.success) {
            displayAnswer(question, data.answer, data.qa_id);
        } else {
            showNotification(data.error || 'Failed to get answer', 'error');
        }
    } catch (error) {
        console.error('Error asking question:', error);
        showNotification('Error connecting to AI. Please try again.', 'error');
    } finally {
        hideLoadingState();
    }
}

function askQuickQuestion(question) {
    document.getElementById('questionInput').value = question;
    askQuestion();
}

function generateAnswer(question) {
    const learningStyle = userLearningStyle;
    const questionLower = question.toLowerCase();
    
    let answer = {
        title: "Answer to: " + question,
        style: learningStyle.charAt(0).toUpperCase() + learningStyle.slice(1) + " Learning Style",
        content: ""
    };
    
    if (questionLower.includes('machine learning') || questionLower.includes('ml')) {
        if (learningStyle === 'visual') {
            answer.content = `
                <h6>Machine Learning - Visual Explanation</h6>
                <p>Machine Learning is like teaching a computer to recognize patterns through visual examples. Think of it as:</p>
                <ul>
                    <li><strong>Data Input:</strong> Like feeding images into a photo album</li>
                    <li><strong>Training:</strong> The algorithm studies patterns in the images</li>
                    <li><strong>Prediction:</strong> It can then identify new images it hasn't seen before</li>
                </ul>
                <p>I recommend looking at flowcharts and diagrams to understand how data flows through ML algorithms. Would you like me to generate some visual content to illustrate this concept?</p>
            `;
        } else if (learningStyle === 'auditory') {
            answer.content = `
                <h6>Machine Learning - Audio Explanation</h6>
                <p>Machine Learning is like teaching a child to recognize sounds and patterns. Here's how it works:</p>
                <ul>
                    <li><strong>Listening Phase:</strong> The algorithm "listens" to lots of data examples</li>
                    <li><strong>Learning Phase:</strong> It identifies patterns and relationships in the data</li>
                    <li><strong>Application Phase:</strong> It can now make predictions on new, unseen data</li>
                </ul>
                <p>I can walk you through this step-by-step verbally, or we could discuss different ML algorithms and their "personalities". What aspect interests you most?</p>
            `;
        } else {
            answer.content = `
                <h6>Machine Learning - Hands-on Approach</h6>
                <p>Machine Learning is like learning to ride a bike - you need hands-on practice! Here's how to approach it:</p>
                <ul>
                    <li><strong>Start Simple:</strong> Try building a basic classifier with real data</li>
                    <li><strong>Experiment:</strong> Change parameters and see how it affects results</li>
                    <li><strong>Practice:</strong> Work on different datasets and problem types</li>
                </ul>
                <p>I can guide you through building your first ML model or show you interactive tools where you can experiment. Ready to get your hands dirty?</p>
            `;
        }
    } else if (questionLower.includes('neural network')) {
        if (learningStyle === 'visual') {
            answer.content = `
                <h6>Neural Networks - Visual Guide</h6>
                <p>Neural networks are like interconnected webs of decision-making nodes! Here's the visual breakdown:</p>
                <ul>
                    <li><strong>Input Layer:</strong> Data enters like water flowing into pipes</li>
                    <li><strong>Hidden Layers:</strong> Processing happens through interconnected nodes</li>
                    <li><strong>Output Layer:</strong> Final decision emerges from the network</li>
                </ul>
                <p>I can show you beautiful diagrams of how data flows through layers and how backpropagation works. Want to see some network visualizations?</p>
            `;
        } else if (learningStyle === 'auditory') {
            answer.content = `
                <h6>Neural Networks - Audio Explanation</h6>
                <p>Neural networks are like a symphony of interconnected musicians! Here's how they work:</p>
                <ul>
                    <li><strong>Each Neuron:</strong> Like a musician that listens to others and contributes to the performance</li>
                    <li><strong>Signals Flow:</strong> Information travels through the network like musical notes</li>
                    <li><strong>Learning:</strong> The network adjusts its "tuning" based on feedback</li>
                </ul>
                <p>I can explain how signals flow through the network and discuss different architectures. Shall we explore this together?</p>
            `;
        } else {
            answer.content = `
                <h6>Neural Networks - Hands-on Approach</h6>
                <p>Neural networks are like building with LEGO blocks! Here's how to understand them:</p>
                <ul>
                    <li><strong>Build Layer by Layer:</strong> Each layer transforms the data in a specific way</li>
                    <li><strong>Experiment:</strong> Try different architectures and see how they perform</li>
                    <li><strong>Practice:</strong> Use neural network simulators to build and test networks</li>
                </ul>
                <p>I can guide you through hands-on exercises with neural network simulators. Ready to build your first network?</p>
            `;
        }
    } else {
        // Generic answer based on learning style
        if (learningStyle === 'visual') {
            answer.content = `
                <h6>Learning-Style Adapted Answer</h6>
                <p>That's an interesting question! Let me break this down visually for you. I can create diagrams, charts, or step-by-step visual guides to help you understand this concept better.</p>
                <p>Visual learners like you often benefit from seeing the big picture and how different parts connect. What specific aspect would you like me to illustrate?</p>
            `;
        } else if (learningStyle === 'auditory') {
            answer.content = `
                <h6>Learning-Style Adapted Answer</h6>
                <p>Great question! Let me walk you through this step by step. I'll explain the concepts verbally, use analogies and stories to make it memorable, and we can discuss different aspects until it clicks.</p>
                <p>Auditory learners like you often benefit from hearing explanations and having conversations about the topic. What would you like to explore further?</p>
            `;
        } else {
            answer.content = `
                <h6>Learning-Style Adapted Answer</h6>
                <p>Excellent question! Let's approach this hands-on. I can provide practical examples, interactive exercises, and real-world applications that you can work through.</p>
                <p>Kinesthetic learners like you often learn best by doing and experimenting. What kind of practical approach would help you understand this better?</p>
            `;
        }
    }
    
    return answer;
}

function displayAnswer(question, answer, qaId) {
    const answerDiv = document.getElementById('questionAnswer');
    const titleElement = document.getElementById('answerTitle');
    const styleElement = document.getElementById('answerStyle');
    const contentElement = document.getElementById('answerContent');
    
    titleElement.textContent = answer.title;
    styleElement.textContent = answer.style;
    contentElement.innerHTML = answer.content;
    
    // Store qa_id for save and rate functions
    answerDiv.setAttribute('data-qa-id', qaId);
    
    // Add confidence score display
    if (answer.confidence_score) {
        const confidenceElement = document.createElement('div');
        confidenceElement.className = 'confidence-score mt-2';
        confidenceElement.innerHTML = `
            <small class="text-muted">
                <i class="bi bi-shield-check"></i> 
                Confidence: ${Math.round(answer.confidence_score * 100)}%
            </small>
        `;
        contentElement.appendChild(confidenceElement);
    }
    
    answerDiv.style.display = 'block';
    answerDiv.scrollIntoView({ behavior: 'smooth' });
}

function showLoadingState() {
    const button = document.querySelector('button[onclick="askQuestion()"]');
    button.innerHTML = '<span class="loading-spinner"></span> Thinking...';
    button.disabled = true;
}

function hideLoadingState() {
    const button = document.querySelector('button[onclick="askQuestion()"]');
    button.innerHTML = '<i class="bi bi-search"></i> Ask';
    button.disabled = false;
}

// Content Generation Functions
function generateContent() {
    const question = document.getElementById('questionInput').value;
    if (!question) return;
    
    showNotification('Generating personalized content for you...', 'info');
    
    // Simulate content generation
    setTimeout(() => {
        showNotification('Content generated successfully! Check your library.', 'success');
    }, 2000);
}

async function saveToLibrary() {
    const answerDiv = document.getElementById('questionAnswer');
    const qaId = answerDiv.getAttribute('data-qa-id');
    
    if (!qaId) {
        showNotification('No Q&A to save', 'error');
        return;
    }
    
    try {
        const response = await fetch('/api/save-qa', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ qa_id: qaId })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification(data.message, 'success');
        } else {
            showNotification(data.error || 'Failed to save Q&A', 'error');
        }
    } catch (error) {
        console.error('Error saving Q&A:', error);
        showNotification('Error saving Q&A. Please try again.', 'error');
    }
}

function askFollowUp() {
    const followUpInput = prompt('What would you like to know more about?');
    if (followUpInput) {
        document.getElementById('questionInput').value = followUpInput;
        askQuestion();
    }
}

async function rateAnswer(rating) {
    const answerDiv = document.getElementById('questionAnswer');
    const qaId = answerDiv.getAttribute('data-qa-id');
    
    if (!qaId) {
        showNotification('No Q&A to rate', 'error');
        return;
    }
    
    try {
        const response = await fetch('/api/rate-qa', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ qa_id: qaId, rating: rating })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification(data.message, 'success');
            updateStarDisplay(rating);
        } else {
            showNotification(data.error || 'Failed to rate Q&A', 'error');
        }
    } catch (error) {
        console.error('Error rating Q&A:', error);
        showNotification('Error rating Q&A. Please try again.', 'error');
    }
}

function updateStarDisplay(rating) {
    const stars = document.querySelectorAll('.rating-star');
    stars.forEach((star, index) => {
        if (index < rating) {
            star.classList.add('filled');
            star.classList.remove('bi-star');
            star.classList.add('bi-star-fill');
        } else {
            star.classList.remove('filled');
            star.classList.remove('bi-star-fill');
            star.classList.add('bi-star');
        }
    });
}

// Recommendation System
async function loadRecommendations() {
    try {
        console.log('Loading personalized recommendations...');
        const response = await fetch('/api/content');
        console.log('Content response status:', response.status);
        
        if (response.ok) {
            const data = await response.json();
            console.log('Content data received:', data);
            
            // Convert API data to recommendation format
            const recommendations = data.content.map(item => ({
                id: item.id,
                type: item.content_type,
                title: item.title,
                description: item.description,
                duration: '15 min', // Default duration
                rating: 4.5, // Default rating
                difficulty: item.difficulty_level || 'Beginner',
                style: item.style_tags && item.style_tags.length > 0 ? item.style_tags[0] : 'general',
                url_path: item.url_path
            }));
            
            currentRecommendations = recommendations;
            displayRecommendations(recommendations);
            
            // Update learning style display
            if (data.user_style) {
                userLearningStyle = data.user_style;
                updateLearningStyleDisplay(data.user_style, data.style_breakdown);
            }
            
        } else {
            console.error('Failed to load content, status:', response.status);
            // Fallback to static recommendations
    const recommendations = generatePersonalizedRecommendations();
    currentRecommendations = recommendations;
    displayRecommendations(recommendations);
        }
    } catch (error) {
        console.error('Error loading recommendations:', error);
        // Fallback to static recommendations
        const recommendations = generatePersonalizedRecommendations();
        currentRecommendations = recommendations;
        displayRecommendations(recommendations);
    }
}

function generatePersonalizedRecommendations() {
    const learningStyle = userLearningStyle;
    const baseRecommendations = [
        {
            id: 1,
            type: 'video',
            title: 'Introduction to Machine Learning',
            description: 'A comprehensive visual guide to machine learning concepts with interactive diagrams and flowcharts.',
            duration: '15 min',
            rating: 4.8,
            difficulty: 'Beginner',
            style: 'visual'
        },
        {
            id: 2,
            type: 'audio',
            title: 'Data Science Podcast Series',
            description: 'Expert discussions on data science trends and techniques, perfect for auditory learners.',
            duration: '25 min',
            rating: 4.6,
            difficulty: 'Intermediate',
            style: 'auditory'
        },
        {
            id: 3,
            type: 'interactive',
            title: 'Hands-on Python Workshop',
            description: 'Practice coding exercises and build real projects to master Python programming.',
            duration: '45 min',
            rating: 4.9,
            difficulty: 'Advanced',
            style: 'kinesthetic'
        },
        {
            id: 4,
            type: 'text',
            title: 'Deep Learning Fundamentals',
            description: 'In-depth written guide covering neural networks, backpropagation, and advanced concepts.',
            duration: '20 min',
            rating: 4.7,
            difficulty: 'Intermediate',
            style: 'visual'
        }
    ];
    
    // Filter and prioritize based on learning style
    return baseRecommendations.filter(rec => rec.style === learningStyle)
        .concat(baseRecommendations.filter(rec => rec.style !== learningStyle))
        .slice(0, 8);
}

function displayRecommendations(recommendations) {
    const grid = document.getElementById('recommendationsGrid');
    grid.innerHTML = '';
    
    recommendations.forEach(rec => {
        const card = createRecommendationCard(rec);
        grid.appendChild(card);
    });
}

function createRecommendationCard(recommendation) {
    const card = document.createElement('div');
    card.className = 'content-card interactive-element';
    
    card.innerHTML = `
        <span class="content-type ${recommendation.type}">${recommendation.type.charAt(0).toUpperCase() + recommendation.type.slice(1)}</span>
        <h4 class="content-title">${recommendation.title}</h4>
        <p class="content-description">${recommendation.description}</p>
        <div class="content-meta">
            <span><i class="bi bi-clock"></i> ${recommendation.duration}</span>
            <span><i class="bi bi-star"></i> ${recommendation.rating}</span>
            <span><i class="bi bi-graph-up"></i> ${recommendation.difficulty}</span>
        </div>
    `;
    
    card.addEventListener('click', () => {
        openContent(recommendation);
    });
    
    return card;
}

function openContent(recommendation) {
    showNotification(`Opening ${recommendation.title}...`, 'info');
    // In a real app, this would open the content
}

function filterContent() {
    const selectedFilter = document.querySelector('input[name="contentFilter"]:checked').id;
    let filteredRecommendations = currentRecommendations;
    
    if (selectedFilter !== 'allContent') {
        const filterType = selectedFilter.replace('Content', '').toLowerCase();
        filteredRecommendations = currentRecommendations.filter(rec => rec.type === filterType);
    }
    
    displayRecommendations(filteredRecommendations);
}

function refreshRecommendations() {
    showNotification('Refreshing recommendations...', 'info');
    setTimeout(() => {
        loadRecommendations();
        showNotification('Recommendations updated!', 'success');
    }, 1000);
}

function updateLearningStyleDisplay(style, breakdown) {
    // Update the learning style display in the dashboard
    const styleElements = document.querySelectorAll('.style-circle');
    const styleLabels = document.querySelectorAll('.style-label');
    const stylePercentages = document.querySelectorAll('.style-percentage');
    
    if (breakdown) {
        // Update style breakdown display
        Object.keys(breakdown).forEach((styleKey, index) => {
            if (stylePercentages[index]) {
                stylePercentages[index].textContent = `${Math.round(breakdown[styleKey] * 100)}%`;
            }
            if (styleLabels[index]) {
                styleLabels[index].textContent = styleKey.charAt(0).toUpperCase() + styleKey.slice(1);
            }
        });
    }
    
    // Update dominant style display
    const dominantStyleElement = document.querySelector('.dominant-style h3');
    if (dominantStyleElement && style) {
        dominantStyleElement.textContent = `Your Learning Style: ${style.charAt(0).toUpperCase() + style.slice(1)}`;
    }
}

async function updateLearningProfile() {
    try {
        const response = await fetch('/api/update-profile', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({})
        });
        
        if (response.ok) {
            const data = await response.json();
            console.log('Learning profile updated:', data.profile);
            
            // Update learning style if it changed
            if (data.profile.dominant_style !== userLearningStyle) {
                userLearningStyle = data.profile.dominant_style;
                updateLearningStyleDisplay(data.profile.dominant_style, data.profile.style_breakdown);
                
                // Reload recommendations with new style
                loadRecommendations();
            }
        }
    } catch (error) {
        console.error('Error updating learning profile:', error);
    }
}

// Engagement Tracking
let engagementData = {
    startTime: Date.now(),
    clickCount: 0,
    scrollDistance: 0,
    pauseCount: 0,
    pauseStartTime: null,
    totalPauseTime: 0
};

function startEngagementTracking() {
    // Track clicks
    document.addEventListener('click', () => {
        engagementData.clickCount++;
    });
    
    // Track scrolling
    let lastScrollTop = 0;
    document.addEventListener('scroll', () => {
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        engagementData.scrollDistance += Math.abs(scrollTop - lastScrollTop);
        lastScrollTop = scrollTop;
    });
    
    // Track pauses (when user stops interacting)
    let lastActivity = Date.now();
    const activityThreshold = 30000; // 30 seconds
    
    setInterval(() => {
        const now = Date.now();
        if (now - lastActivity > activityThreshold) {
            if (!engagementData.pauseStartTime) {
                engagementData.pauseStartTime = now;
                engagementData.pauseCount++;
            }
        } else {
            if (engagementData.pauseStartTime) {
                engagementData.totalPauseTime += now - engagementData.pauseStartTime;
                engagementData.pauseStartTime = null;
            }
        }
    }, 5000); // Check every 5 seconds
    
    // Reset activity timer on user interaction
    ['click', 'scroll', 'keypress', 'mousemove'].forEach(event => {
        document.addEventListener(event, () => {
            lastActivity = Date.now();
        });
    });
    
    // Send engagement data periodically
    setInterval(sendEngagementData, 60000); // Every minute
}

async function sendEngagementData() {
    try {
        const currentTime = Date.now();
        const interactionTime = (currentTime - engagementData.startTime) / 1000; // Convert to seconds
        const scrollVelocity = engagementData.scrollDistance / (interactionTime || 1);
        const pauseDuration = engagementData.totalPauseTime / 1000; // Convert to seconds
        
        // Calculate completion rate based on content viewed
        const contentElements = document.querySelectorAll('.content-card');
        const viewedContent = Array.from(contentElements).filter(el => {
            const rect = el.getBoundingClientRect();
            return rect.top < window.innerHeight && rect.bottom > 0;
        }).length;
        const completionRate = contentElements.length > 0 ? viewedContent / contentElements.length : 0;
        
        const engagementPayload = {
            content_id: 1, // Default content ID for dashboard
            interaction_time: interactionTime,
            completion_rate: completionRate,
            click_frequency: engagementData.clickCount / (interactionTime / 60), // Clicks per minute
            scroll_velocity: scrollVelocity,
            pause_duration: pauseDuration,
            context: 'general'
        };
        
        const response = await fetch('/api/engagement', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(engagementPayload)
        });
        
        if (response.ok) {
            const data = await response.json();
            console.log('Engagement tracked:', data);
            
            // Reset engagement data
            engagementData = {
                startTime: Date.now(),
                clickCount: 0,
                scrollDistance: 0,
                pauseCount: 0,
                pauseStartTime: null,
                totalPauseTime: 0
            };
        }
    } catch (error) {
        console.error('Error tracking engagement:', error);
    }
}

async function generatePersonalizedContent() {
    showNotification('Generating personalized content based on your learning style...', 'info');
    
    try {
        const response = await fetch('/api/generate-content', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                topic: 'Personalized Learning',
                content_type: userLearningStyle === 'visual' ? 'video' : userLearningStyle === 'auditory' ? 'audio' : 'interactive'
            })
        });
        
        if (response.ok) {
            const data = await response.json();
        const newContent = {
                id: data.content.id,
                type: data.content.content_type,
                title: data.content.title,
                description: data.content.content.substring(0, 100) + '...',
            duration: '30 min',
            rating: 5.0,
                difficulty: data.content.difficulty_level || 'Personalized',
                style: data.content.learning_style,
                url_path: '#'
        };
        
        currentRecommendations.unshift(newContent);
        displayRecommendations(currentRecommendations);
        showNotification('New personalized content generated!', 'success');
        } else {
            throw new Error('Failed to generate content');
        }
    } catch (error) {
        console.error('Error generating content:', error);
        showNotification('Failed to generate content. Please try again.', 'error');
    }
}

// Utility Functions
function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'info' ? 'info' : type === 'success' ? 'success' : 'warning'} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-remove after 3 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 3000);
}

// CSS for animations
const style = document.createElement('style');
style.textContent = `
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .content-card, .stat-card {
        opacity: 0;
    }
`;
document.head.appendChild(style);

// Load learning sites data
async function loadLearningSitesData() {
    try {
        console.log(' Loading learning sites data...');
        const response = await fetch('/api/learning-sites?per_page=5');
        console.log(' Response status:', response.status);
        
        if (response.ok) {
            const data = await response.json();
            console.log(' API Response:', data);
            console.log(' Activities count:', data.activities ? data.activities.length : 0);
            updateRecentSites(data.activities);
        } else {
            console.log(' API Error:', response.status);
            document.getElementById('recent-sites').innerHTML = '<div class="text-muted">No recent activity</div>';
        }
    } catch (error) {
        console.error(' Error loading learning sites data:', error);
        document.getElementById('recent-sites').innerHTML = '<div class="text-muted">Error loading data</div>';
    }
}

// Update recent sites display
function updateRecentSites(activities) {
    console.log(' updateRecentSites called with:', activities);
    const container = document.getElementById('recent-sites');
    
    if (!container) {
        console.error(' Container element not found!');
        return;
    }
    
    if (!activities || activities.length === 0) {
        console.log(' No activities, showing empty state');
        container.innerHTML = '<div class="text-muted">No recent activity</div>';
        return;
    }
    
    console.log(' Processing', activities.length, 'activities');
    
    let html = '';
    activities.forEach(activity => {
        const timeAgo = getTimeAgo(new Date(activity.timestamp));
        const siteIcon = getSiteIcon(activity.site_name);
        const siteUrl = activity.site_url || '#';
        const duration = activity.duration_minutes || activity.time_spent || 0;
        
        html += `
            <div class="site-activity-item d-flex align-items-center mb-2 p-2 border rounded clickable-site-item" 
                 onclick="openLearningSite('${siteUrl}', '${activity.site_name}', ${activity.id})"
                 style="cursor: pointer; transition: all 0.2s ease;"
                 onmouseover="this.style.backgroundColor='#f8f9fa'" 
                 onmouseout="this.style.backgroundColor=''">
                <div class="site-icon me-3">
                    <i class="${siteIcon}"></i>
                </div>
                <div class="flex-grow-1">
                    <div class="site-name fw-bold text-primary">${activity.site_name || 'Unknown Site'}</div>
                    <div class="site-details text-muted small">
                        ${activity.activity_type || 'visit'}  ${duration}min  ${timeAgo}
                    </div>
                    <div class="site-content-info small text-info" style="display: none;">
                        <i class="bi bi-info-circle"></i> Click to view content details
                    </div>
                </div>
                <div class="site-action">
                    <i class="bi bi-arrow-right-circle text-muted"></i>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// Open learning site and show content details
function openLearningSite(url, siteName, activityId) {
    console.log(' Opening learning site:', siteName, 'URL:', url);
    
    // Show content details modal
    showContentDetails(siteName, activityId);
    
    // Open the site in a new tab
    if (url && url !== '#') {
        window.open(url, '_blank');
    }
}

// Show content details modal
function showContentDetails(siteName, activityId) {
    // Create modal HTML
    const modalHtml = `
        <div class="modal fade" id="contentDetailsModal" tabindex="-1" aria-labelledby="contentDetailsModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="contentDetailsModalLabel">
                            <i class="bi bi-globe"></i> ${siteName} - Content Details
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div id="contentDetailsBody">
                            <div class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2">Loading content details...</p>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" onclick="openSiteInNewTab()">Visit Site</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('contentDetailsModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to page
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('contentDetailsModal'));
    modal.show();
    
    // Load content details
    loadContentDetails(siteName, activityId);
}

// Load detailed content information
async function loadContentDetails(siteName, activityId) {
    try {
        const response = await fetch(`/api/learning-sites/${activityId}/content`);
        if (response.ok) {
            const data = await response.json();
            displayContentDetails(data);
        } else {
            // Fallback to basic content details
            displayBasicContentDetails(siteName, activityId);
        }
    } catch (error) {
        console.error('Error loading content details:', error);
        displayBasicContentDetails(siteName, activityId);
    }
}

// Display content details
function displayContentDetails(data) {
    const contentBody = document.getElementById('contentDetailsBody');
    
    const html = `
        <div class="row">
            <div class="col-md-6">
                <h6><i class="bi bi-info-circle"></i> Site Information</h6>
                <ul class="list-unstyled">
                    <li><strong>Site:</strong> ${data.site_name}</li>
                    <li><strong>URL:</strong> <a href="${data.site_url}" target="_blank">${data.site_url}</a></li>
                    <li><strong>Duration:</strong> ${data.duration_minutes} minutes</li>
                    <li><strong>Last Visit:</strong> ${new Date(data.timestamp).toLocaleString()}</li>
                    <li><strong>Engagement:</strong> ${Math.round(data.engagement_score * 100)}%</li>
                </ul>
            </div>
            <div class="col-md-6">
                <h6><i class="bi bi-book"></i> Content Details</h6>
                <ul class="list-unstyled">
                    <li><strong>Content Type:</strong> ${data.content_type || 'Learning Material'}</li>
                    <li><strong>Subject:</strong> ${data.subject || 'General'}</li>
                    <li><strong>Difficulty:</strong> ${data.difficulty_level || 'Intermediate'}</li>
                    <li><strong>Progress:</strong> ${data.progress_percentage || 0}%</li>
                    <li><strong>Topics:</strong> ${data.topics_covered || 'Various'}</li>
                </ul>
            </div>
        </div>
        
        ${data.content_title ? `
        <div class="mt-3">
            <h6><i class="bi bi-file-text"></i> Content Title</h6>
            <p class="bg-light p-3 rounded">${data.content_title}</p>
        </div>
        ` : ''}
        
        ${data.description ? `
        <div class="mt-3">
            <h6><i class="bi bi-card-text"></i> Description</h6>
            <p>${data.description}</p>
        </div>
        ` : ''}
        
        <div class="mt-3">
            <h6><i class="bi bi-graph-up"></i> Learning Analytics</h6>
            <div class="row">
                <div class="col-md-4">
                    <div class="text-center">
                        <div class="h4 text-primary">${data.total_time || 0}</div>
                        <small class="text-muted">Total Time (min)</small>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="text-center">
                        <div class="h4 text-success">${data.completion_rate || 0}%</div>
                        <small class="text-muted">Completion Rate</small>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="text-center">
                        <div class="h4 text-warning">${data.engagement_score || 0}</div>
                        <small class="text-muted">Engagement Score</small>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    contentBody.innerHTML = html;
}

// Display basic content details (fallback)
function displayBasicContentDetails(siteName, activityId) {
    const contentBody = document.getElementById('contentDetailsBody');
    
    const html = `
        <div class="row">
            <div class="col-md-6">
                <h6><i class="bi bi-info-circle"></i> Site Information</h6>
                <ul class="list-unstyled">
                    <li><strong>Site:</strong> ${siteName}</li>
                    <li><strong>Activity ID:</strong> ${activityId}</li>
                    <li><strong>Last Visit:</strong> ${new Date().toLocaleString()}</li>
                </ul>
            </div>
            <div class="col-md-6">
                <h6><i class="bi bi-book"></i> Content Details</h6>
                <ul class="list-unstyled">
                    <li><strong>Content Type:</strong> Learning Material</li>
                    <li><strong>Subject:</strong> General</li>
                    <li><strong>Status:</strong> Active</li>
                </ul>
            </div>
        </div>
        
        <div class="mt-3">
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i>
                <strong>Note:</strong> Detailed content information will be available when you visit the site and engage with learning materials.
            </div>
        </div>
    `;
    
    contentBody.innerHTML = html;
}

// Open site in new tab
function openSiteInNewTab() {
    // This will be implemented to open the actual site
    console.log('Opening site in new tab...');
}

// Load permissions status
async function loadPermissionsStatus() {
    try {
        const response = await fetch('/api/permissions');
        if (response.ok) {
            const data = await response.json();
            updatePermissionsStatus(data.permissions);
        }
    } catch (error) {
        console.error('Error loading permissions status:', error);
    }
}

// Update permissions status display
function updatePermissionsStatus(permissions) {
    const statusElements = {
        'edu-tracking-status': permissions.eduSites,
        'coding-tracking-status': permissions.coding,
        'video-tracking-status': permissions.video,
        'research-tracking-status': permissions.research
    };
    
    Object.entries(statusElements).forEach(([elementId, isEnabled]) => {
        const element = document.getElementById(elementId);
        if (element) {
            if (isEnabled) {
                element.textContent = 'Enabled';
                element.className = 'badge bg-success';
            } else {
                element.textContent = 'Disabled';
                element.className = 'badge bg-secondary';
            }
        }
    });
}

// Get site icon based on site name
function getSiteIcon(siteName) {
    const icons = {
        'Coursera': 'bi bi-mortarboard',
        'Khan Academy': 'bi bi-book',
        'edX': 'bi bi-graduation-cap',
        'Udemy': 'bi bi-play-circle',
        'GitHub': 'bi bi-github',
        'Stack Overflow': 'bi bi-stack-overflow',
        'YouTube': 'bi bi-youtube',
        'Google Scholar': 'bi bi-search',
        'ResearchGate': 'bi bi-file-text'
    };
    
    return icons[siteName] || 'bi bi-globe';
}

// Format time duration
function formatTime(seconds) {
    if (seconds < 60) {
        return `${seconds}s`;
    } else if (seconds < 3600) {
        const minutes = Math.floor(seconds / 60);
        return `${minutes}m`;
    } else {
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        return `${hours}h ${minutes}m`;
    }
}

// Get time ago string
function getTimeAgo(date) {
    const now = new Date();
    const diffInSeconds = Math.floor((now - date) / 1000);
    
    if (diffInSeconds < 60) {
        return 'Just now';
    } else if (diffInSeconds < 3600) {
        const minutes = Math.floor(diffInSeconds / 60);
        return `${minutes}m ago`;
    } else if (diffInSeconds < 86400) {
        const hours = Math.floor(diffInSeconds / 3600);
        return `${hours}h ago`;
    } else {
        const days = Math.floor(diffInSeconds / 86400);
        return `${days}d ago`;
    }
}
</script>
{% endblock %}
