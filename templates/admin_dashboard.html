{% extends "base.html" %}

{% block title %}Admin Dashboard - LearnStyle AI{% endblock %}

{% block head %}
<style>
.admin-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 2rem;
}

.admin-header {
    background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
    color: white;
    border-radius: 15px;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
}

.admin-title {
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
}

.admin-subtitle {
    font-size: 1.2rem;
    opacity: 0.9;
    margin-bottom: 0;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.stat-card {
    background: white;
    border-radius: 15px;
    padding: 1.5rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    border-left: 5px solid #007bff;
    transition: transform 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-5px);
}

.stat-card.users {
    border-left-color: #28a745;
}

.stat-card.content {
    border-left-color: #ffc107;
}

.stat-card.analytics {
    border-left-color: #17a2b8;
}

.stat-card.system {
    border-left-color: #6f42c1;
}

.stat-number {
    font-size: 2.5rem;
    font-weight: bold;
    color: #333;
    margin-bottom: 0.5rem;
}

.stat-label {
    color: #666;
    font-weight: 500;
    margin-bottom: 0.5rem;
}

.stat-change {
    font-size: 0.9rem;
    font-weight: 500;
}

.stat-change.positive {
    color: #28a745;
}

.stat-change.negative {
    color: #dc3545;
}

.admin-section {
    background: white;
    border-radius: 15px;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.section-title {
    font-size: 1.5rem;
    font-weight: 600;
    margin-bottom: 1.5rem;
    color: #333;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.table-responsive {
    border-radius: 10px;
    overflow: hidden;
}

.table {
    margin-bottom: 0;
}

.table th {
    background: #f8f9fa;
    border: none;
    font-weight: 600;
    color: #495057;
}

.table td {
    border: none;
    vertical-align: middle;
}

.user-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(45deg, #667eea, #764ba2);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 1.1rem;
}

.role-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 15px;
    font-size: 0.8rem;
    font-weight: 500;
}

.role-admin {
    background: #dc3545;
    color: white;
}

.role-moderator {
    background: #ffc107;
    color: #212529;
}

.role-user {
    background: #6c757d;
    color: white;
}

.status-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 15px;
    font-size: 0.8rem;
    font-weight: 500;
}

.status-active {
    background: #d4edda;
    color: #155724;
}

.status-inactive {
    background: #f8d7da;
    color: #721c24;
}

.action-buttons {
    display: flex;
    gap: 0.5rem;
}

.btn-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.8rem;
}

.chart-container {
    position: relative;
    height: 300px;
    margin: 1rem 0;
}

.quick-actions {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-top: 2rem;
}

.quick-action-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 15px;
    padding: 1.5rem;
    text-align: center;
    cursor: pointer;
    transition: transform 0.3s ease;
    text-decoration: none;
}

.quick-action-card:hover {
    transform: translateY(-5px);
    color: white;
    text-decoration: none;
}

.quick-action-icon {
    font-size: 2rem;
    margin-bottom: 1rem;
}

.quick-action-title {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.quick-action-desc {
    font-size: 0.9rem;
    opacity: 0.9;
}

.modal-content {
    border-radius: 15px;
    border: none;
}

.modal-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 15px 15px 0 0;
    border: none;
}

.modal-title {
    font-weight: 600;
}

.btn-close {
    filter: invert(1);
}

@media (max-width: 768px) {
    .admin-container {
        padding: 1rem;
    }
    
    .stats-grid {
        grid-template-columns: 1fr;
    }
    
    .quick-actions {
        grid-template-columns: 1fr;
    }
    
    .action-buttons {
        flex-direction: column;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="admin-container">
    <!-- Admin Header -->
    <div class="admin-header">
        <h1 class="admin-title">
            <i class="bi bi-shield-check"></i> Admin Dashboard
        </h1>
        <p class="admin-subtitle">
            System management and analytics for LearnStyle AI
        </p>
    </div>

    <!-- Statistics Overview -->
    <div class="stats-grid">
        <div class="stat-card users">
            <div class="stat-number" id="totalUsers">0</div>
            <div class="stat-label">Total Users</div>
            <div class="stat-change positive">+12% this month</div>
        </div>
        
        <div class="stat-card content">
            <div class="stat-number" id="totalContent">0</div>
            <div class="stat-label">Content Items</div>
            <div class="stat-change positive">+8% this month</div>
        </div>
        
        <div class="stat-card analytics">
            <div class="stat-number" id="activeUsers">0</div>
            <div class="stat-label">Active Users</div>
            <div class="stat-change positive">+15% this week</div>
        </div>
        
        <div class="stat-card system">
            <div class="stat-number" id="systemHealth">98%</div>
            <div class="stat-label">System Health</div>
            <div class="stat-change positive">All systems operational</div>
        </div>
    </div>

    <!-- User Management -->
    <div class="admin-section">
        <h2 class="section-title">
            <i class="bi bi-people"></i> User Management
        </h2>
        
        <div class="row mb-3">
            <div class="col-md-6">
                <div class="input-group">
                    <input type="text" class="form-control" id="userSearch" placeholder="Search users...">
                    <button class="btn btn-outline-secondary" onclick="searchUsers()">
                        <i class="bi bi-search"></i>
                    </button>
                </div>
            </div>
            <div class="col-md-6 text-end">
                <button class="btn btn-primary" onclick="showAddUserModal()">
                    <i class="bi bi-person-plus"></i> Add User
                </button>
            </div>
        </div>
        
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Email</th>
                        <th>Role</th>
                        <th>Status</th>
                        <th>Last Login</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="usersTableBody">
                    <!-- Users will be loaded dynamically -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Content Management -->
    <div class="admin-section">
        <h2 class="section-title">
            <i class="bi bi-collection"></i> Content Management
        </h2>
        
        <div class="row mb-3">
            <div class="col-md-6">
                <div class="input-group">
                    <input type="text" class="form-control" id="contentSearch" placeholder="Search content...">
                    <button class="btn btn-outline-secondary" onclick="searchContent()">
                        <i class="bi bi-search"></i>
                    </button>
                </div>
            </div>
            <div class="col-md-6 text-end">
                <button class="btn btn-success" onclick="showAddContentModal()">
                    <i class="bi bi-plus-circle"></i> Add Content
                </button>
            </div>
        </div>
        
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Title</th>
                        <th>Type</th>
                        <th>Style Tags</th>
                        <th>Difficulty</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="contentTableBody">
                    <!-- Content will be loaded dynamically -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Analytics -->
    <div class="admin-section">
        <h2 class="section-title">
            <i class="bi bi-graph-up"></i> System Analytics
        </h2>
        
        <div class="row">
            <div class="col-md-6">
                <h5>Learning Style Distribution</h5>
                <div class="chart-container">
                    <canvas id="learningStyleChart"></canvas>
                </div>
            </div>
            <div class="col-md-6">
                <h5>User Activity Over Time</h5>
                <div class="chart-container">
                    <canvas id="activityChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="quick-actions">
        <a href="#" class="quick-action-card" onclick="exportData()">
            <div class="quick-action-icon">
                <i class="bi bi-download"></i>
            </div>
            <div class="quick-action-title">Export Data</div>
            <div class="quick-action-desc">Download user and analytics data</div>
        </a>
        
        <a href="#" class="quick-action-card" onclick="systemSettings()">
            <div class="quick-action-icon">
                <i class="bi bi-gear"></i>
            </div>
            <div class="quick-action-title">System Settings</div>
            <div class="quick-action-desc">Configure system parameters</div>
        </a>
        
        <a href="#" class="quick-action-card" onclick="backupSystem()">
            <div class="quick-action-icon">
                <i class="bi bi-shield-check"></i>
            </div>
            <div class="quick-action-title">Backup System</div>
            <div class="quick-action-desc">Create system backup</div>
        </a>
        
        <a href="#" class="quick-action-card" onclick="viewLogs()">
            <div class="quick-action-icon">
                <i class="bi bi-file-text"></i>
            </div>
            <div class="quick-action-title">View Logs</div>
            <div class="quick-action-desc">System and error logs</div>
        </a>
    </div>
</div>

<!-- Add User Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addUserForm">
                    <div class="mb-3">
                        <label for="newUsername" class="form-label">Username</label>
                        <input type="text" class="form-control" id="newUsername" required>
                    </div>
                    <div class="mb-3">
                        <label for="newEmail" class="form-label">Email</label>
                        <input type="email" class="form-control" id="newEmail" required>
                    </div>
                    <div class="mb-3">
                        <label for="newPassword" class="form-label">Password</label>
                        <input type="password" class="form-control" id="newPassword" required>
                    </div>
                    <div class="mb-3">
                        <label for="newRole" class="form-label">Role</label>
                        <select class="form-select" id="newRole" required>
                            <option value="user">User</option>
                            <option value="moderator">Moderator</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addUser()">Add User</button>
            </div>
        </div>
    </div>
</div>

<script>
// Admin Dashboard JavaScript
let usersData = [];
let contentData = [];

// Initialize admin dashboard
document.addEventListener('DOMContentLoaded', function() {
    loadDashboardData();
    initializeCharts();
});

// Load dashboard data
async function loadDashboardData() {
    try {
        // Load users
        const usersResponse = await fetch('/api/admin/users');
        usersData = await usersResponse.json();
        displayUsers(usersData);
        
        // Load content
        const contentResponse = await fetch('/api/admin/content');
        contentData = await contentResponse.json();
        displayContent(contentData);
        
        // Update statistics
        updateStatistics();
        
    } catch (error) {
        console.error('Error loading dashboard data:', error);
        showNotification('Error loading dashboard data', 'error');
    }
}

// Display users in table
function displayUsers(users) {
    const tbody = document.getElementById('usersTableBody');
    tbody.innerHTML = '';
    
    users.forEach(user => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>
                <div class="d-flex align-items-center">
                    <div class="user-avatar me-2">
                        ${user.username.charAt(0).toUpperCase()}
                    </div>
                    <div>
                        <div class="fw-bold">${user.username}</div>
                        <small class="text-muted">ID: ${user.id}</small>
                    </div>
                </div>
            </td>
            <td>${user.email}</td>
            <td><span class="role-badge role-${user.role}">${user.role}</span></td>
            <td><span class="status-badge status-${user.is_active ? 'active' : 'inactive'}">${user.is_active ? 'Active' : 'Inactive'}</span></td>
            <td>${user.last_login ? new Date(user.last_login).toLocaleDateString() : 'Never'}</td>
            <td>
                <div class="action-buttons">
                    <button class="btn btn-sm btn-outline-primary" onclick="editUser(${user.id})">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteUser(${user.id})">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// Display content in table
function displayContent(content) {
    const tbody = document.getElementById('contentTableBody');
    tbody.innerHTML = '';
    
    content.forEach(item => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>
                <div class="fw-bold">${item.title}</div>
                <small class="text-muted">${item.description.substring(0, 50)}...</small>
            </td>
            <td><span class="badge bg-info">${item.content_type}</span></td>
            <td>${item.style_tags || 'N/A'}</td>
            <td><span class="badge bg-secondary">${item.difficulty_level || 'N/A'}</span></td>
            <td>${new Date(item.created_at).toLocaleDateString()}</td>
            <td>
                <div class="action-buttons">
                    <button class="btn btn-sm btn-outline-primary" onclick="editContent(${item.id})">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteContent(${item.id})">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// Update statistics
function updateStatistics() {
    document.getElementById('totalUsers').textContent = usersData.length;
    document.getElementById('totalContent').textContent = contentData.length;
    document.getElementById('activeUsers').textContent = usersData.filter(u => u.is_active).length;
}

// Initialize charts
function initializeCharts() {
    // Learning Style Distribution Chart
    const learningStyleCtx = document.getElementById('learningStyleChart').getContext('2d');
    new Chart(learningStyleCtx, {
        type: 'doughnut',
        data: {
            labels: ['Visual', 'Auditory', 'Kinesthetic'],
            datasets: [{
                data: [45, 30, 25],
                backgroundColor: ['#3498db', '#e74c3c', '#f39c12'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
    
    // Activity Chart
    const activityCtx = document.getElementById('activityChart').getContext('2d');
    new Chart(activityCtx, {
        type: 'line',
        data: {
            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
            datasets: [{
                label: 'Active Users',
                data: [12, 19, 3, 5, 2, 3],
                borderColor: '#667eea',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

// User management functions
function searchUsers() {
    const searchTerm = document.getElementById('userSearch').value.toLowerCase();
    const filteredUsers = usersData.filter(user => 
        user.username.toLowerCase().includes(searchTerm) ||
        user.email.toLowerCase().includes(searchTerm)
    );
    displayUsers(filteredUsers);
}

function showAddUserModal() {
    new bootstrap.Modal(document.getElementById('addUserModal')).show();
}

function addUser() {
    const form = document.getElementById('addUserForm');
    const formData = new FormData(form);
    
    const userData = {
        username: document.getElementById('newUsername').value,
        email: document.getElementById('newEmail').value,
        password: document.getElementById('newPassword').value,
        role: document.getElementById('newRole').value
    };
    
    // Simulate API call
    showNotification('Adding user...', 'info');
    setTimeout(() => {
        showNotification('User added successfully!', 'success');
        bootstrap.Modal.getInstance(document.getElementById('addUserModal')).hide();
        form.reset();
        loadDashboardData();
    }, 1000);
}

function editUser(userId) {
    showNotification('Edit user functionality coming soon!', 'info');
}

function deleteUser(userId) {
    if (confirm('Are you sure you want to delete this user?')) {
        showNotification('Deleting user...', 'info');
        setTimeout(() => {
            showNotification('User deleted successfully!', 'success');
            loadDashboardData();
        }, 1000);
    }
}

// Content management functions
function searchContent() {
    const searchTerm = document.getElementById('contentSearch').value.toLowerCase();
    const filteredContent = contentData.filter(item => 
        item.title.toLowerCase().includes(searchTerm) ||
        item.description.toLowerCase().includes(searchTerm)
    );
    displayContent(filteredContent);
}

function showAddContentModal() {
    showNotification('Add content functionality coming soon!', 'info');
}

function editContent(contentId) {
    showNotification('Edit content functionality coming soon!', 'info');
}

function deleteContent(contentId) {
    if (confirm('Are you sure you want to delete this content?')) {
        showNotification('Deleting content...', 'info');
        setTimeout(() => {
            showNotification('Content deleted successfully!', 'success');
            loadDashboardData();
        }, 1000);
    }
}

// Quick actions
function exportData() {
    showNotification('Exporting data...', 'info');
    setTimeout(() => {
        showNotification('Data exported successfully!', 'success');
    }, 2000);
}

function systemSettings() {
    showNotification('System settings coming soon!', 'info');
}

function backupSystem() {
    showNotification('Creating system backup...', 'info');
    setTimeout(() => {
        showNotification('Backup created successfully!', 'success');
    }, 3000);
}

function viewLogs() {
    showNotification('View logs functionality coming soon!', 'info');
}

// Utility function
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 3000);
}
</script>
{% endblock %}
